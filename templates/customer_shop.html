{% include '_page_start.html' %}

<style>
  .shop-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }
  .shop-grid--carousel {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    scroll-behavior: smooth;
    padding-bottom: 4px;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .shop-grid--carousel::-webkit-scrollbar {
    display: none;
  }
  .shop-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 220px;
    scroll-snap-align: start;
  }
  .shop-card img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 6px;
    background: #f4f4f4;
  }
  .shop-card h3 {
    margin: 0;
    font-size: 1rem;
  }
  .shop-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: #444;
  }
  .shop-card form {
    margin-top: auto;
  }
  .shop-card button {
    width: 100%;
    padding: 8px 10px;
  }
  .shop-link {
    color: inherit;
    text-decoration: none;
  }
  .shop-section {
    margin-bottom: 28px;
  }
  .shop-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 12px;
  }
  .shop-section h2 {
    margin: 0 0 12px;
  }
  .shop-section-header h2 {
    margin: 0;
  }
  .shop-carousel-controls {
    display: flex;
    gap: 8px;
  }
  .carousel-btn {
    width: 36px;
    height: 36px;
    padding: 0;
    font-size: 20px;
    line-height: 1;
    border-radius: 50%;
  }
  .carousel-btn:disabled {
    opacity: 0.5;
  }
  .shop-empty {
    margin: 0;
    color: #666;
  }
  .flashes {
    padding-left: 16px;
    margin-bottom: 12px;
  }
</style>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul class="flashes">
      {% for message in messages %}
        <li><span>{{ message }}</span><button class="flash-close" type="button" aria-label="Close">&times;</button></li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

{% set header_title = "Petshop Store" %}
{% set show_search = true %}
{% set search_action = "/shop/search" %}
{% set search_query = "" %}
{% include "_customer_shop_header.html" %}

<div class="shop-section">
  <div class="shop-section-header">
    <h2>Bestsellers</h2>
    <div class="shop-carousel-controls">
      <button class="btn btn-outline-secondary btn-sm carousel-btn prev" type="button" aria-label="Previous items" disabled>&lsaquo;</button>
      <button class="btn btn-outline-secondary btn-sm carousel-btn next" type="button" aria-label="Next items">&rsaquo;</button>
    </div>
  </div>
  {% if bestsellers %}
    <div class="shop-grid shop-grid--carousel" data-items="{{ bestsellers|length }}">
      {% for product in bestsellers %}
        <div class="shop-card">
          <a class="shop-link" href="/product/{{ product.id }}">
            {% if product.image %}
              <img src="data:image/jpeg;base64,{{ product.image }}" alt="{{ product.descriere }}">
            {% else %}
              <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="No image available">
            {% endif %}
            <h3>{{ product.descriere }}</h3>
          </a>
          <div class="shop-meta">
            <span>{{ "{:,.2f}".format(product.pret) }} lei</span>
            <span>Stock: {{ product.stoc }}</span>
          </div>
          <form method="post" action="/cart/add">
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <button type="submit" {% if product.stoc <= 0 %}disabled{% endif %}>Add to cart</button>
          </form>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="shop-empty">No bestseller data yet.</p>
  {% endif %}
</div>

<div class="shop-section">
  {% if random_category %}
    <div class="shop-section-header">
      <h2>Items in {{ random_category.name }}</h2>
      <div class="shop-carousel-controls">
        <button class="btn btn-outline-secondary btn-sm carousel-btn prev" type="button" aria-label="Previous items" disabled>&lsaquo;</button>
        <button class="btn btn-outline-secondary btn-sm carousel-btn next" type="button" aria-label="Next items">&rsaquo;</button>
      </div>
    </div>
    {% if category_products %}
      <div class="shop-grid shop-grid--carousel" data-items="{{ category_products|length }}">
        {% for product in category_products %}
          <div class="shop-card">
            <a class="shop-link" href="/product/{{ product.id }}">
              {% if product.image %}
                <img src="data:image/jpeg;base64,{{ product.image }}" alt="{{ product.descriere }}">
              {% else %}
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="No image available">
              {% endif %}
              <h3>{{ product.descriere }}</h3>
            </a>
            <div class="shop-meta">
              <span>{{ "{:,.2f}".format(product.pret) }} lei</span>
              <span>Stock: {{ product.stoc }}</span>
            </div>
            <form method="post" action="/cart/add">
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <button type="submit" {% if product.stoc <= 0 %}disabled{% endif %}>Add to cart</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="shop-empty">No items found in this category.</p>
    {% endif %}
  {% else %}
    <p class="shop-empty">No categories with items found.</p>
  {% endif %}
</div>

<div class="shop-section">
  {% if random_subcategory %}
    <div class="shop-section-header">
      <h2>Items in {{ random_subcategory.category_name }}/{{ random_subcategory.name }}</h2>
      <div class="shop-carousel-controls">
        <button class="btn btn-outline-secondary btn-sm carousel-btn prev" type="button" aria-label="Previous items" disabled>&lsaquo;</button>
        <button class="btn btn-outline-secondary btn-sm carousel-btn next" type="button" aria-label="Next items">&rsaquo;</button>
      </div>
    </div>
    {% if subcategory_products %}
      <div class="shop-grid shop-grid--carousel" data-items="{{ subcategory_products|length }}">
        {% for product in subcategory_products %}
          <div class="shop-card">
            <a class="shop-link" href="/product/{{ product.id }}">
              {% if product.image %}
                <img src="data:image/jpeg;base64,{{ product.image }}" alt="{{ product.descriere }}">
              {% else %}
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="No image available">
              {% endif %}
              <h3>{{ product.descriere }}</h3>
            </a>
            <div class="shop-meta">
              <span>{{ "{:,.2f}".format(product.pret) }} lei</span>
              <span>Stock: {{ product.stoc }}</span>
            </div>
            <form method="post" action="/cart/add">
              <input type="hidden" name="product_id" value="{{ product.id }}">
              <button type="submit" {% if product.stoc <= 0 %}disabled{% endif %}>Add to cart</button>
            </form>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="shop-empty">No items found in this subcategory.</p>
    {% endif %}
  {% else %}
    <p class="shop-empty">No subcategories with items found.</p>
  {% endif %}
</div>

<script>
  const carousels = document.querySelectorAll('.shop-grid--carousel');

  carousels.forEach((carousel) => {
    const section = carousel.closest('.shop-section');
    const prev = section.querySelector('.carousel-btn.prev');
    const next = section.querySelector('.carousel-btn.next');

    const updateButtons = () => {
      const maxScroll = carousel.scrollWidth - carousel.clientWidth;
      const atStart = carousel.scrollLeft <= 1;
      const atEnd = carousel.scrollLeft >= maxScroll - 1;
      const hasOverflow = maxScroll > 1;

      prev.disabled = !hasOverflow || atStart;
      next.disabled = !hasOverflow || atEnd;
    };

    prev.addEventListener('click', () => {
      carousel.scrollBy({ left: -carousel.clientWidth, behavior: 'smooth' });
    });

    next.addEventListener('click', () => {
      carousel.scrollBy({ left: carousel.clientWidth, behavior: 'smooth' });
    });

    carousel.addEventListener('scroll', () => {
      window.requestAnimationFrame(updateButtons);
    });

    window.addEventListener('resize', updateButtons);

    carousel.querySelectorAll('img').forEach((img) => {
      if (img.complete) {
        return;
      }
      img.addEventListener('load', updateButtons, { once: true });
      img.addEventListener('error', updateButtons, { once: true });
    });

    window.requestAnimationFrame(updateButtons);
    window.setTimeout(updateButtons, 0);
  });
</script>

{% include '_page_end.html' %}


